<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HROne Public Scanner</title>
    
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/logo.png') }}">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { background-color: #111; overflow: hidden; }
        #kiosk-view { display: flex !important; }
        .video-container {
            width: 100%;
            max-width: 500px;
            aspect-ratio: 4/3;
            border: 3px solid #28a745;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            background: #000;
        }
        #kiosk-video { width: 100%; height: 100%; object-fit: cover; }
        #kiosk-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.canvasjs.com/canvasjs.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
</head>

<body class="bg-dark text-white">

    <div id="kiosk-view" class="vh-100 flex-column align-items-center justify-content-center p-3">
        
        <div class="position-absolute top-0 end-0 m-3">
            <span class="badge bg-success shadow"><i class="fas fa-wifi"></i> Online</span>
        </div>

        <div class="text-center mb-4">
            <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Logo" width="60" class="mb-2">
            <h4 class="fw-bold mb-0">HROne Attendance</h4>
            <small class="text-secondary">Public Biometric Scanner</small>
        </div>

        <div class="video-container shadow mb-4">
            <video id="kiosk-video" autoplay muted playsinline></video>
            <canvas id="kiosk-canvas"></canvas>
        </div>

        <div class="text-center w-100" style="max-width: 400px;">
            <div id="scan-message" class="alert alert-dark border-secondary fw-bold">
                <div class="spinner-border spinner-border-sm text-success me-2" role="status"></div>
                Initializing System...
            </div>
            
            <button class="btn btn-outline-success btn-sm mt-3" onclick="forceStartCamera()">
                <i class="fas fa-camera me-2"></i> Click if Camera doesn't start
            </button>
        </div>

        <div class="fixed-bottom text-center pb-3">
            <small class="text-secondary" style="font-size: 0.75rem;">&copy; 2026 Subhalaxmi Group</small>
        </div>
    </div>

    <div id="login-section" class="d-none">
        <form id="login-form"></form><input id="login-user"><input id="login-pass">
        <div id="system-status-badge"></div>
        <input type="checkbox" id="system-lock-toggle">
    </div>
    <div id="dashboard-layout" class="d-none">
        <div id="current-date"></div><div id="mob-current-date"></div><div id="dynamic-year"></div>
        <div id="weather-temp"></div><div id="mob-weather"></div><div id="mob-aqi"></div>
        <div id="mob-aqi-nav"></div><div id="activity-log-body"></div><div id="lunch-log-body"></div>
        <div id="selected-date-display"></div><div id="kpi-present"></div>
        <div id="kpi-absent"></div><div id="kpi-hours"></div>
        <div id="calendar-grid"></div><div id="calendar-month-year"></div>
        <select id="filter-designation"></select>
        <button id="advancedReportsBtn"></button>
        <button id="closeReportsBtn"></button>
        <div id="maintenance-overlay"></div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>

    <script>
        function forceStartCamera() {
            if (window.app && window.app.startKioskScanner) {
                document.getElementById('scan-message').innerText = "Starting Camera...";
                app.startKioskScanner();
            } else {
                alert("System still loading... please wait 5 seconds and try again.");
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log("Public Kiosk: Booting...");
            
            // Wait 1.5s for script.js to initialize Supabase and Models
            setTimeout(() => {
                if (window.app) {
                    // Inject a fake 'switchView' bypass if needed, or just call logic directly
                    if(app.switchView) {
                        app.switchView('kiosk');
                    } else {
                        app.loadFaceData().then(() => app.startKioskScanner());
                    }
                    
                    const msg = document.getElementById('scan-message');
                    if(msg) msg.innerHTML = "Align Face within Frame";
                }
            }, 1500);
        });
    </script>
</body>
</html>
